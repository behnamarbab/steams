{% extends 'base.html' %}

{% block title %}Chat with {{ user_to_chat_with.username }}{% endblock %}

{% block content %}
<h2>Chat with {{ user_to_chat_with.username }}</h2>
<div id="chat-box">
    {% for message in messages %}
        <p><strong>{{ message.sender.username }}:</strong> {{ message.content }}</p>
    {% endfor %}
</div>
<form id="message-form">
    {% csrf_token %}
    {{ message_form.as_p }}
    <button type="submit">Send</button>
</form>

<script>
    function connect() {
        var chatSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/chat/{{ chat_id }}/'
        );
 
        chatSocket.onopen = function(e) {
            console.log('WebSocket connection opened');
        };
 
        chatSocket.onmessage = function(e) {
            var data = JSON.parse(e.data);
            var message = data.message;
            var sender = data.sender;
 
            $('#chat-box').append('<p><strong>' + sender + ':</strong> ' + message + '</p>');
        };
 
        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
            setTimeout(function() {
                connect();
            }, 5000);
        };
 
        chatSocket.onerror = function(e) {
            console.error('WebSocket error:', e);
            chatSocket.close();
        };
 
        $(document).ready(function() {
            $('#message-form').submit(function(e) {
                e.preventDefault();
                var message = $('#id_content').val();
                if (chatSocket.readyState === WebSocket.OPEN) {
                    chatSocket.send(JSON.stringify({
                        'message': message,
                        'sender_id': '{{ request.user.id }}'
                    }));
                    $('#id_content').val('');
                } else {
                    console.error('WebSocket is not open. Unable to send message.');
                }
            });
        });
    }
 
    connect();
 </script>
 
{% endblock %}
